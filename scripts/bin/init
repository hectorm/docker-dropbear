#!/bin/busybox sh
# shellcheck shell=sh

set -eu

umask 0077

EUID=$(id -u)
EGID=$(id -g)

printf '%s\n' "dropbear:x:${EGID:?}:dropbear" > /etc/group
printf '%s\n' "dropbear:x:${EUID:?}:${EGID:?}::/:/bin/sh" > /etc/passwd
printf '%s\n' "dropbear:*:0:0:99999:7:::" > /etc/shadow

if [ ! -e /etc/dropbear/ ]; then
	mkdir /etc/dropbear/
fi

if [ ! -e /etc/dropbear/dropbear_dss_host_key ]; then
	dropbearkey -t dss -f /etc/dropbear/dropbear_dss_host_key >/dev/null
fi
if [ ! -e /etc/dropbear/dropbear_rsa_host_key ]; then
	dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key >/dev/null
fi
if [ ! -e /etc/dropbear/dropbear_ecdsa_host_key ]; then
	dropbearkey -t ecdsa -f /etc/dropbear/dropbear_ecdsa_host_key >/dev/null
fi
if [ ! -e /etc/dropbear/dropbear_ed25519_host_key ]; then
	dropbearkey -t ed25519 -f /etc/dropbear/dropbear_ed25519_host_key >/dev/null
fi

# Merge all variables starting with "DROPBEAR_USER"
DROPBEAR_USERS=$(awk 'BEGIN { for (v in ENVIRON) if (v ~ /^DROPBEAR_USER/) print(ENVIRON[v]) }')

_IFS=${IFS}; IFS=$(printf '\nx'); IFS=${IFS%x}
for entry in ${DROPBEAR_USERS?}; do
	# USERNAME:(plain|encrypted):PASSWORD:UID:GID
	user=${entry%%:*};  entry=${entry#*:}
	ptype=${entry%%:*}; entry=${entry#*:}
	pass=${entry%%:*};  entry=${entry#*:}
	uid=${entry%%:*};   entry=${entry#*:}
	gid=${entry%%:*};   entry=${entry#*:}

	if [ -n "${pass?}" ] && [ "${ptype:?}" = 'plain' ]; then
		phash=$(mkpasswd -m sha256crypt "${pass:?}")
	else
		phash=${pass:-'*'}
	fi

	if [ "${EUID:?}" != 0 ]; then
		uid=${EUID:?}
		gid=${EGID:?}
	fi

	printf '%s\n' "${user:?}:x:${gid:?}:${user:?}" >> /etc/group
	printf '%s\n' "${user:?}:x:${uid:?}:${gid:?}::/home/${user:?}:/bin/sh" >> /etc/passwd
	printf '%s\n' "${user:?}:${phash:?}:0:0:99999:7:::" >> /etc/shadow

	if [ ! -e "/home/${user:?}/" ]; then
		mkdir "/home/${user:?}/"
	fi

	authorizedKeys=/home/${user:?}/.ssh/authorized_keys
	if [ -e "${authorizedKeys:?}.d/" ]; then
		printf '%s\n' '# AUTOGENERATED, DO NOT EDIT!' > "${authorizedKeys:?}"
		for f in "${authorizedKeys:?}.d/"*; do
			[ -f "${f:?}" ] || continue
			awk 1 "${f:?}" >> "${authorizedKeys:?}"
		done
	fi

	if [ "${EUID:?}" = 0 ]; then
		chmod 700 "/home/${user:?}/" "/home/${user:?}/.ssh/" 2>/dev/null ||:
		chown -R "${uid:?}:${gid:?}" "/home/${user:?}/" 2>/dev/null ||:
	fi
done
IFS=$_IFS

if [ "${EUID:?}" = 0 ]; then
	chmod 755 /etc/dropbear/ || true
	chmod 755 /home/
	chmod 644 /etc/group /etc/passwd
	chmod 600 /etc/shadow
fi

umask 0002

exec /bin/dropbear "${@}"
